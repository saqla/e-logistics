// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 箱車シフト：上段左のルート種別
enum ShiftRouteKind {
  SANCHOKU      // 産直
  DONKI_FUKUOKA // ドンキ(福岡)
  DONKI_NAGASAKI// ドンキ(長崎)
  UNIC          // ユニック
  OFF           // 休み
  PAID_LEAVE    // 有給
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Audit logs
  auditLogs AuditLog[]
  staffs    Staff[]

  @@map("users")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String   // "login", "logout", etc.
  details   String?  // Additional details in JSON format
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("audit_logs")
}

// スタッフの種別
enum StaffKind {
  ALL     // All（どの業務にも割当可能）
  UNIC    // ユニック
  HAKO    // 箱車
  JIMU    // 事務
}

// スタッフ
model Staff {
  id         String     @id @default(cuid())
  name       String
  kind       StaffKind
  userId     String?    @unique
  user       User?      @relation(fields: [userId], references: [id], onDelete: SetNull)
  deletedAt  DateTime?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  // relations
  routeAssignments RouteAssignment[]
  lowerAssignments LowerAssignment[]
  shiftAssignments ShiftAssignment[]

  @@index([name])
  @@map("staffs")
}

// 上段：通常業務以外のメモ（1セル=テキストのみ）
model DayNote {
  id        String   @id @default(cuid())
  year      Int
  month     Int      // 1-12
  day       Int      // 1-31（表示都合で31固定想定）
  slot      Int      // 1..4（上段メモのスロット）
  text      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([year, month, day, slot], name: "year_month_day_slot")
  @@map("day_notes")
}

// 上段最下部3行のルート種別
enum RouteKind {
  EZAKI_DONKI
  SANCHOKU
  MARUNO_DONKI
}

// 連結/休配の特別値（前日継続・配送なし）
enum RouteSpecialValue {
  CONTINUE  // ―
  OFF       // ×
}

// 下段セルの色
enum LowerCellColor {
  WHITE
  PINK
}

// 上段最下部3行：1日×3行の担当
model RouteAssignment {
  id        String    @id @default(cuid())
  year      Int
  month     Int
  day       Int
  route     RouteKind
  staffId   String?
  special   RouteSpecialValue?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  staff     Staff?    @relation(fields: [staffId], references: [id])

  @@unique([year, month, day, route])
  @@index([year, month, day])
  @@map("route_assignments")
}

// 下段：休み表示 1日あたり13行
model LowerAssignment {
  id        String   @id @default(cuid())
  year      Int
  month     Int
  day       Int
  rowIndex  Int      // 1..13
  staffId   String?
  color     LowerCellColor @default(WHITE)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  staff     Staff?   @relation(fields: [staffId], references: [id])

  // 同じ日に同じスタッフを重複選択させない（NULLは許容）
  @@unique([year, month, day, staffId])
  @@unique([year, month, day, rowIndex])
  @@index([year, month, day])
  @@map("lower_assignments")
}

// 右側備考エリア
model Remark {
  id        String   @id @default(cuid())
  title     String
  body      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("remarks")
}

// 箱車シフト：1日×スタッフごとの4セル（左上/右上/左下/右下）
model ShiftAssignment {
  id        String          @id @default(cuid())
  year      Int
  month     Int
  day       Int
  staffId   String
  route     ShiftRouteKind  // 左上セル
  carNumber String?         // 右上セル（8514/3717/4825/?/空白）
  noteBL    String?         // 左下セル（自由入力）
  noteBR    String?         // 右下セル（自由入力）
  // 自動生成補助
  role      String?         // 'driver' | 'assistant' など（将来enum化予定）
  priority  Int?            // 小さいほど優先、未指定は0扱い
  ignoreInSchedule Boolean? // 予定表投影から除外
  scheduleRouteKey RouteKind? // 予定表の3ルート種別に直接マップ
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  staff     Staff           @relation(fields: [staffId], references: [id])

  @@unique([year, month, day, staffId])
  @@index([year, month, day])
  @@map("shift_assignments")
}